<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Tracker</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        *:focus {
            outline: none;
        }

        *:active {
            outline: none;
        }

        button:focus,
        button:active,
        a:focus,
        a:active,
        input:focus,
        input:active,
        select:focus,
        select:active {
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #ffffff;
            color: #026E81;
            overflow-x: hidden;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Overlay */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(2, 110, 129, 0.5);
            z-index: 999;
            display: none;
            transition: opacity 0.3s;
        }

        .sidebar-overlay.show {
            display: block;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: #ffffff;
            padding: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s;
            transform: translateX(-100%);
            box-shadow: 2px 0 10px rgba(2, 110, 129, 0.1);
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(2, 110, 129, 0.1);
        }

        .sidebar-header .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #00ABBD;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 24px;
            color: white;
        }

        .sidebar-header .user-info h3 {
            font-size: 18px;
            margin-bottom: 5px;
            color: #026E81;
        }

        .sidebar-header .user-info p {
            font-size: 14px;
            opacity: 0.7;
            color: #026E81;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 10px;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            text-decoration: none;
            color: #026E81;
            border-radius: 10px;
            transition: background 0.2s;
            font-size: 16px;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: #00ABBD;
            color: white;
        }

        .sidebar-menu a .icon {
            margin-right: 12px;
            font-size: 20px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            max-width: 100%;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .menu-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            color: #026E81;
            -webkit-tap-highlight-color: transparent;
        }

        .menu-button:focus,
        .menu-button:active {
            outline: none;
        }

        .header-title {
            font-size: 24px;
            font-weight: 600;
            color: #026E81;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Balance Card */
        .balance-card {
            background: linear-gradient(135deg, #00ABBD 0%, #0099DD 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(2, 110, 129, 0.2);
        }

        .balance-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .balance-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .account-selector {
            background: rgba(255,255,255,0.25);
            border: 1px solid rgba(255,255,255,0.4);
            color: white;
            padding: 8px 35px 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='white' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 12px;
            transition: all 0.2s;
        }

        .account-selector:hover {
            background-color: rgba(255,255,255,0.35);
            border-color: rgba(255,255,255,0.6);
        }

        .account-selector:focus {
            outline: none;
            border-color: rgba(255,255,255,0.8);
            background-color: rgba(255,255,255,0.4);
            box-shadow: 0 0 0 2px rgba(255,255,255,0.2);
        }

        .account-selector option {
            background: #00ABBD;
            color: white;
            padding: 10px;
        }

        .balance-amount {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        /* Type Selector */
        .type-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .type-button {
            flex: 1;
            padding: 12px;
            border: 2px solid rgba(2, 110, 129, 0.2);
            background: #ffffff;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            color: #026E81;
            -webkit-tap-highlight-color: transparent;
        }

        .type-button:focus,
        .type-button:active {
            outline: none;
        }

        .type-button.active {
            background: #00ABBD;
            color: white;
            border-color: #00ABBD;
        }

        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Summary Card */
        .summary-card {
            background: rgba(161, 199, 224, 0.2);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .summary-label {
            font-size: 14px;
            opacity: 0.7;
            margin-bottom: 5px;
            color: #026E81;
        }

        .summary-amount {
            font-size: 28px;
            font-weight: 700;
            color: #00ABBD;
        }

        /* Transactions List */
        .transactions-list {
            list-style: none;
        }

        .transaction-item {
            background: rgba(161, 199, 224, 0.15);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .transaction-item:active {
            transform: scale(0.98);
            -webkit-tap-highlight-color: transparent;
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .transaction-category {
            font-weight: 600;
            font-size: 16px;
            color: #026E81;
        }

        .transaction-amount {
            font-size: 18px;
            font-weight: 700;
        }

        .transaction-amount.expense {
            color: #026E81;
        }

        .transaction-amount.income {
            color: #FF9933;
        }

        .transaction-details {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            opacity: 0.7;
            color: #026E81;
        }

        /* Accounts Page */
        .accounts-summary {
            background: linear-gradient(135deg, #00ABBD 0%, #0099DD 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .accounts-summary-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .accounts-summary-amount {
            font-size: 32px;
            font-weight: 700;
        }

        .accounts-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .action-button {
            flex: 1;
            padding: 15px;
            background: #0099DD;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .action-button:active {
            opacity: 0.8;
            -webkit-tap-highlight-color: transparent;
        }

        .accounts-list {
            list-style: none;
        }

        .account-item {
            background: rgba(161, 199, 224, 0.15);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .account-item:active {
            transform: scale(0.98);
            -webkit-tap-highlight-color: transparent;
        }

        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .account-name {
            font-weight: 600;
            font-size: 16px;
            color: #026E81;
        }

        .account-balance {
            font-size: 18px;
            font-weight: 700;
            color: #00ABBD;
        }

        .account-currency {
            font-size: 14px;
            opacity: 0.7;
            color: #026E81;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(2, 110, 129, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        #alertIcon {
            display: inline-block;
            width: 60px;
            height: 60px;
            line-height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .modal-content {
            background: #ffffff;
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #026E81;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #026E81;
            -webkit-tap-highlight-color: transparent;
        }

        .close-button:focus,
        .close-button:active {
            outline: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: #026E81;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(2, 110, 129, 0.2);
            border-radius: 10px;
            font-size: 16px;
            background: #ffffff;
            color: #026E81;
        }

        .form-input:focus {
            outline: none;
            border-color: #00ABBD;
            -webkit-tap-highlight-color: transparent;
        }

        .form-input[type="number"] {
            -moz-appearance: textfield;
        }

        .form-input[type="number"]::-webkit-inner-spin-button,
        .form-input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .categories-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .category-button {
            flex: 0 1 calc(33.333% - 7px);
            min-width: 0;
            padding: 10px;
            border: 2px solid rgba(2, 110, 129, 0.2);
            background: #ffffff;
            border-radius: 10px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            color: #026E81;
            -webkit-tap-highlight-color: transparent;
            aspect-ratio: 1;
        }

        .category-button:focus,
        .category-button:active {
            outline: none;
        }

        .category-button.active {
            background: #00ABBD;
            color: white;
            border-color: #00ABBD;
        }

        .category-button .icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .submit-button {
            width: 100%;
            padding: 15px;
            background: #00ABBD;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .submit-button:active {
            opacity: 0.8;
            -webkit-tap-highlight-color: transparent;
        }

        .delete-button {
            width: 100%;
            padding: 15px;
            background: #ce5a57;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        .delete-button:active {
            opacity: 0.8;
            -webkit-tap-highlight-color: transparent;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            opacity: 0.5;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 20px;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="avatar">üë§</div>
                <div class="user-info">
                    <h3 id="userName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h3>
                    <p id="userTelegramId">@username</p>
                </div>
            </div>
            <ul class="sidebar-menu">
                <li><a href="#" class="menu-link active" data-tab="home">
                    <span class="icon">üè†</span>
                    <span>–ì–ª–∞–≤–Ω–∞—è</span>
                </a></li>
                <li><a href="#" class="menu-link" data-tab="accounts">
                    <span class="icon">üí≥</span>
                    <span>–°—á–µ—Ç–∞</span>
                </a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="header">
                <button class="menu-button" id="menuButton">‚ò∞</button>
                <h1 class="header-title" id="pageTitle">–ì–ª–∞–≤–Ω–∞—è</h1>
                <div style="width: 40px;"></div>
            </div>

            <!-- Home Tab -->
            <div class="tab-content active" id="homeTab">
                <!-- Balance Card -->
                <div class="balance-card">
                    <div class="balance-header">
                        <span class="balance-label">–ë–∞–ª–∞–Ω—Å</span>
                        <select class="account-selector" id="balanceAccountSelect">
                            <option value="all">–í—Å–µ —Å—á–µ—Ç–∞</option>
                        </select>
                    </div>
                    <div class="balance-amount" id="balanceAmount">0 ‚ÇΩ</div>
                </div>

                <!-- Type Selector -->
                <div class="type-selector">
                    <button class="type-button active" data-type="expense">–†–∞—Å—Ö–æ–¥—ã</button>
                    <button class="type-button" data-type="income">–î–æ—Ö–æ–¥—ã</button>
                </div>


                <!-- Summary Card -->
                <div class="summary-card">
                    <div class="summary-label" id="summaryLabel">–†–∞—Å—Ö–æ–¥—ã –∑–∞ –ø–µ—Ä–∏–æ–¥</div>
                    <div class="summary-amount" id="summaryAmount">0 ‚ÇΩ</div>
                </div>

                <!-- Transactions List -->
                <ul class="transactions-list" id="transactionsList">
                    <li class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</li>
                </ul>
            </div>

            <!-- Accounts Tab -->
            <div class="tab-content" id="accountsTab">
                <!-- Accounts Summary -->
                <div class="accounts-summary">
                    <div class="accounts-summary-label">–ò—Ç–æ–≥–æ –ø–æ –≤—Å–µ–º —Å—á–µ—Ç–∞–º</div>
                    <div class="accounts-summary-amount" id="totalBalance">0 ‚ÇΩ</div>
                </div>

                <!-- Actions -->
                <div class="accounts-actions">
                    <button class="action-button" id="transferHistoryBtn">–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤</button>
                    <button class="action-button" id="transferBtn">–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏</button>
                </div>

                <!-- Accounts List -->
                <ul class="accounts-list" id="accountsList">
                    <li class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</li>
                </ul>

                <!-- Add Account Button -->
                <button class="submit-button" id="addAccountBtn" style="margin-top: 20px;">+ –î–æ–±–∞–≤–∏—Ç—å —Å—á–µ—Ç</button>
            </div>
        </main>
    </div>

    <!-- Transaction Form Modal -->
    <div class="modal" id="transactionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="transactionModalTitle">–î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</h2>
                <button class="close-button" onclick="closeModal('transactionModal')">√ó</button>
            </div>
            <form id="transactionForm">
                <div class="form-group">
                    <label class="form-label">–°—É–º–º–∞</label>
                    <input type="text" class="form-input" id="transactionAmount" placeholder="0.00" inputmode="decimal" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–°—á–µ—Ç</label>
                    <select class="form-input" id="transactionAccount" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—á–µ—Ç</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <div class="categories-grid" id="categoriesGrid"></div>
                    <button type="button" class="action-button" id="moreCategoriesBtn" style="margin-top: 10px;">–ï—â–µ...</button>
                </div>
                <div class="form-group">
                    <label class="form-label">–î–∞—Ç–∞</label>
                    <input type="date" class="form-input" id="transactionDate" max="" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <input type="text" class="form-input" id="transactionComment" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
                </div>
                <button type="submit" class="submit-button">–°–æ–∑–¥–∞—Ç—å</button>
            </form>
        </div>
    </div>

    <!-- Transaction Edit Modal -->
    <div class="modal" id="transactionEditModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é</h2>
                <button class="close-button" onclick="closeModal('transactionEditModal')">√ó</button>
            </div>
            <form id="transactionEditForm">
                <div class="form-group">
                    <label class="form-label">–°—É–º–º–∞</label>
                    <input type="text" class="form-input" id="editTransactionAmount" placeholder="0.00" inputmode="decimal" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                    <select class="form-input" id="editTransactionCategory" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label">–î–∞—Ç–∞</label>
                    <input type="date" class="form-input" id="editTransactionDate" max="" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                    <input type="text" class="form-input" id="editTransactionComment" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
                </div>
                <button type="submit" class="submit-button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button type="button" class="delete-button" id="deleteTransactionBtn">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <!-- Account Form Modal -->
    <div class="modal" id="accountModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="accountModalTitle">–î–æ–±–∞–≤–∏—Ç—å —Å—á–µ—Ç</h2>
                <button class="close-button" onclick="closeModal('accountModal')">√ó</button>
            </div>
            <form id="accountForm">
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" class="form-input" id="accountName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å—á–µ—Ç–∞" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–ë–∞–ª–∞–Ω—Å</label>
                    <input type="text" class="form-input" id="accountBalance" placeholder="0.00 (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" inputmode="decimal">
                </div>
                <button type="submit" class="submit-button">–°–æ–∑–¥–∞—Ç—å</button>
            </form>
        </div>
    </div>

    <!-- Account Edit Modal -->
    <div class="modal" id="accountEditModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—á–µ—Ç</h2>
                <button class="close-button" onclick="closeModal('accountEditModal')">√ó</button>
            </div>
            <form id="accountEditForm">
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" class="form-input" id="editAccountName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å—á–µ—Ç–∞" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–ë–∞–ª–∞–Ω—Å</label>
                    <input type="text" class="form-input" id="editAccountBalance" placeholder="0.00" inputmode="decimal" required>
                </div>
                <button type="submit" class="submit-button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button type="button" class="delete-button" id="deleteAccountBtn">–£–¥–∞–ª–∏—Ç—å —Å—á–µ—Ç</button>
            </form>
        </div>
    </div>

    <!-- Transfer Modal -->
    <div class="modal" id="transferModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏</h2>
                <button class="close-button" onclick="closeModal('transferModal')">√ó</button>
            </div>
            <form id="transferForm">
                <div class="form-group">
                    <label class="form-label">–° –∫–∞–∫–æ–≥–æ —Å—á–µ—Ç–∞</label>
                    <select class="form-input" id="transferFromAccount" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label">–ù–∞ –∫–∞–∫–æ–π —Å—á–µ—Ç</label>
                    <select class="form-input" id="transferToAccount" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label">–°—É–º–º–∞</label>
                    <input type="text" class="form-input" id="transferAmount" placeholder="0.00" inputmode="decimal" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <input type="text" class="form-input" id="transferComment" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
                </div>
                <button type="submit" class="submit-button">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>
            </form>
        </div>
    </div>

    <!-- Transfer History Modal -->
    <div class="modal" id="transferHistoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤</h2>
                <button class="close-button" onclick="closeModal('transferHistoryModal')">√ó</button>
            </div>
            <ul class="transactions-list" id="transferHistoryList">
                <li class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</li>
            </ul>
        </div>
    </div>

    <!-- Transfer Edit Modal -->
    <div class="modal" id="transferEditModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–≤–æ–¥</h2>
                <button class="close-button" onclick="closeModal('transferEditModal')">√ó</button>
            </div>
            <form id="transferEditForm">
                <div class="form-group">
                    <label class="form-label">–° –∫–∞–∫–æ–≥–æ —Å—á–µ—Ç–∞</label>
                    <select class="form-input" id="editTransferFromAccount" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label">–ù–∞ –∫–∞–∫–æ–π —Å—á–µ—Ç</label>
                    <select class="form-input" id="editTransferToAccount" required></select>
                </div>
                <div class="form-group">
                    <label class="form-label">–°—É–º–º–∞</label>
                    <input type="text" class="form-input" id="editTransferAmount" placeholder="0.00" inputmode="decimal" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–î–∞—Ç–∞</label>
                    <input type="date" class="form-input" id="editTransferDate" max="" required>
                </div>
                <div class="form-group">
                    <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                    <input type="text" class="form-input" id="editTransferComment" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
                </div>
                <button type="submit" class="submit-button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button type="button" class="delete-button" id="deleteTransferBtn">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
        </div>
    </div>

    <!-- More Categories Modal -->
    <div class="modal" id="moreCategoriesModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
                <button class="close-button" onclick="closeModal('moreCategoriesModal')">√ó</button>
            </div>
            <div class="categories-grid" id="allCategoriesGrid"></div>
            <button class="action-button" id="addCategoryBtn" style="margin-top: 20px;">+ –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
        </div>
    </div>

    <!-- Add Category Modal -->
    <div class="modal" id="addCategoryModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h2>
                <button class="close-button" onclick="closeModal('addCategoryModal')">√ó</button>
            </div>
            <form id="addCategoryForm">
                <div class="form-group">
                    <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" class="form-input" id="categoryName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" required>
                </div>
                <button type="submit" class="submit-button">–°–æ–∑–¥–∞—Ç—å</button>
            </form>
        </div>
    </div>

    <!-- Alert Modal -->
    <div class="modal" id="alertModal" style="z-index: 3000;">
        <div class="modal-content" style="max-width: 280px; text-align: center; padding: 0; border-radius: 16px; overflow: hidden;">
            <div id="alertIconContainer" style="padding: 20px 20px 15px; background: linear-gradient(135deg, #0099DD 0%, #00ABBD 100%);">
                <div id="alertIcon" style="font-size: 48px; margin-bottom: 0;">‚úì</div>
            </div>
            <div style="padding: 18px 20px 20px;">
                <div id="alertMessage" style="font-size: 15px; font-weight: 600; color: #026E81; line-height: 1.4; word-wrap: break-word; margin-bottom: 18px;">–°–æ–æ–±—â–µ–Ω–∏–µ</div>
                <button type="button" class="submit-button" id="alertOkBtn" style="width: 100%; margin-top: 0; padding: 10px; font-size: 14px; border-radius: 10px; background: linear-gradient(135deg, #0099DD 0%, #00ABBD 100%); border: none; box-shadow: 0 2px 8px rgba(0, 153, 221, 0.3); cursor: pointer;">OK</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirmationModal" style="z-index: 3000;">
        <div class="modal-content" style="max-width: 350px; text-align: center;">
            <div style="margin-bottom: 20px; font-size: 18px; font-weight: 600;" id="confirmationMessage">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</div>
            <div style="display: flex; gap: 10px;">
                <button type="button" class="action-button" onclick="closeModal('confirmationModal')" style="background: #e0e0e0; color: #333; flex: 1;">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="delete-button" id="confirmDeleteBtn" style="margin-top: 0; flex: 1;">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const gatewayUrl = tg.initDataUnsafe?.start_param ? 
            `${window.location.origin.replace('/webapp', '')}` : 
            (window.location.origin.includes('localhost') ? 'http://localhost:8080' : window.location.origin.replace('/webapp', ''));

        const telegramId = tg.initDataUnsafe?.user?.id;
        if (!telegramId) {
            document.body.innerHTML = '<div style="padding: 20px; text-align: center;">–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</div>';
        }

        // State
        let currentTab = 'home';
        let currentType = 'expense';
        let currentPeriod = 'day';
        let currentDate = new Date();
        let periodStartDate = null;
        let periodEndDate = null;
        let accounts = [];
        let categories = [];
        let editingTransactionId = null;
        let editingAccountId = null;
        let selectedCategoryId = null;

        // Custom Alert Modal (replaces tg.showAlert and alert)
        function showAlert(message, type = 'auto') {
            if (!message || typeof message !== 'string') {
                message = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞';
            }
            // Limit message length for display
            message = String(message).substring(0, 500);
            if (message.length === 0) {
                message = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞';
            }
            
            // Auto-detect type if not specified
            if (type === 'auto') {
                const lowerMessage = message.toLowerCase();
                if (lowerMessage.includes('–æ—à–∏–±–∫–∞') || lowerMessage.includes('–Ω–µ —É–¥–∞–ª–æ—Å—å') || lowerMessage.includes('–Ω–µ–ª—å–∑—è')) {
                    type = 'error';
                } else if (lowerMessage.includes('—Å–æ–∑–¥–∞–Ω') || lowerMessage.includes('–æ–±–Ω–æ–≤–ª–µ–Ω') || lowerMessage.includes('—É–¥–∞–ª–µ–Ω') || 
                          lowerMessage.includes('–≤—ã–ø–æ–ª–Ω–µ–Ω') || lowerMessage.includes('—É—Å–ø–µ—à–Ω–æ')) {
                    type = 'success';
                } else {
                    type = 'info';
                }
            }
            
            return new Promise((resolve) => {
                const modal = document.getElementById('alertModal');
                const messageElement = document.getElementById('alertMessage');
                const iconElement = document.getElementById('alertIcon');
                const iconContainer = document.getElementById('alertIconContainer');
                const okBtn = document.getElementById('alertOkBtn');
                
                messageElement.textContent = message;
                
                // Set icon and colors based on type
                let icon, bgGradient, btnGradient, btnShadow;
                if (type === 'success') {
                    icon = '‚úì';
                    bgGradient = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
                    btnGradient = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
                    btnShadow = '0 4px 12px rgba(76, 175, 80, 0.3)';
                } else if (type === 'error') {
                    icon = '‚úï';
                    bgGradient = 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)';
                    btnGradient = 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)';
                    btnShadow = '0 4px 12px rgba(244, 67, 54, 0.3)';
                } else {
                    icon = '‚Ñπ';
                    bgGradient = 'linear-gradient(135deg, #0099DD 0%, #00ABBD 100%)';
                    btnGradient = 'linear-gradient(135deg, #0099DD 0%, #00ABBD 100%)';
                    btnShadow = '0 4px 12px rgba(0, 153, 221, 0.3)';
                }
                
                iconElement.textContent = icon;
                iconContainer.style.background = bgGradient;
                okBtn.style.background = btnGradient;
                okBtn.style.boxShadow = btnShadow;
                
                // Remove old listeners
                const newOkBtn = okBtn.cloneNode(true);
                okBtn.parentNode.replaceChild(newOkBtn, okBtn);
                
                // Add new listener
                newOkBtn.addEventListener('click', () => {
                    closeModal('alertModal');
                    resolve();
                });
                
                // Handle outside click
                const handleClose = () => {
                    resolve();
                    modal.removeEventListener('click', outsideClickHandler);
                };
                
                const outsideClickHandler = (e) => {
                    if (e.target === modal) {
                        handleClose();
                    }
                };
                
                modal.addEventListener('click', outsideClickHandler);
                
                // Show modal
                modal.classList.add('show');
            });
        }

        // Confirmation Dialog
        function showConfirmDialog(message) {
            return new Promise((resolve) => {
                const modal = document.getElementById('confirmationModal');
                const messageElement = document.getElementById('confirmationMessage');
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                
                messageElement.textContent = message;
                
                // Remove old listeners
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                
                // Add new listener
                newConfirmBtn.addEventListener('click', () => {
                    closeModal('confirmationModal');
                    resolve(true);
                });
                
                // Handle cancel/close
                const handleCancel = () => {
                    resolve(false);
                    modal.removeEventListener('click', outsideClickHandler);
                };
                
                const outsideClickHandler = (e) => {
                    if (e.target === modal) {
                        handleCancel();
                    }
                };
                
                modal.addEventListener('click', outsideClickHandler);
                
                // Show modal
                modal.classList.add('show');
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –¥–∞—Ç—É (—Å–µ–≥–æ–¥–Ω—è) –¥–ª—è –ø–æ–ª–µ–π –¥–∞—Ç—ã
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transactionDate').setAttribute('max', today);
            document.getElementById('editTransactionDate').setAttribute('max', today);
            
            setupEventListeners();
            loadUserInfo();
            loadAccounts();
            loadCategories(currentType);
            loadHomeData();
        });

        function setupEventListeners() {
            // Sidebar
            document.getElementById('menuButton').addEventListener('click', toggleSidebar);
            document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);
            document.querySelectorAll('.menu-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tab = e.currentTarget.dataset.tab;
                    switchTab(tab);
                    closeSidebar();
                });
            });

            // Type selector
            document.querySelectorAll('.type-button').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    currentType = e.currentTarget.dataset.type;
                    document.querySelectorAll('.type-button').forEach(b => b.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    loadCategories(currentType);
                    loadHomeData();
                });
            });


            // Balance account selector
            document.getElementById('balanceAccountSelect').addEventListener('change', () => {
                loadBalance();
            });

            // Forms
            document.getElementById('transactionForm').addEventListener('submit', handleTransactionSubmit);
            document.getElementById('transactionEditForm').addEventListener('submit', handleTransactionEditSubmit);
            document.getElementById('accountForm').addEventListener('submit', handleAccountSubmit);
            document.getElementById('accountEditForm').addEventListener('submit', handleAccountEditSubmit);
            document.getElementById('transferForm').addEventListener('submit', handleTransferSubmit);
            document.getElementById('transferEditForm').addEventListener('submit', handleTransferEditSubmit);
            document.getElementById('deleteTransferBtn').addEventListener('click', handleDeleteTransfer);
            document.getElementById('addCategoryForm').addEventListener('submit', handleAddCategorySubmit);

            // Buttons
            document.getElementById('addAccountBtn').addEventListener('click', () => {
                document.getElementById('accountModalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Å—á–µ—Ç';
                document.getElementById('accountForm').reset();
                openModal('accountModal');
            });

            document.getElementById('transferBtn').addEventListener('click', () => {
                loadTransferForm();
                openModal('transferModal');
            });

            document.getElementById('transferHistoryBtn').addEventListener('click', () => {
                loadTransferHistory();
                openModal('transferHistoryModal');
            });

            document.getElementById('deleteTransactionBtn').addEventListener('click', handleDeleteTransaction);
            document.getElementById('deleteAccountBtn').addEventListener('click', handleDeleteAccount);
            document.getElementById('moreCategoriesBtn').addEventListener('click', () => {
                loadAllCategories();
                openModal('moreCategoriesModal');
            });
            document.getElementById('addCategoryBtn').addEventListener('click', () => {
                openModal('addCategoryModal');
            });

            // Simple amount validation - allow only 0-9, dot and comma, only one dot/comma
            function setupAmountValidation(inputId) {
                const input = document.getElementById(inputId);
                if (!input) return;
                
                input.addEventListener('input', function() {
                    let value = this.value;
                    
                    // Remove all characters except 0-9, dot, comma
                    value = value.replace(/[^0-9.,]/g, '');
                    
                    // Check if dot or comma already exists
                    const hasDot = value.includes('.');
                    const hasComma = value.includes(',');
                    
                    // If both exist, keep only the first one
                    if (hasDot && hasComma) {
                        const dotPos = value.indexOf('.');
                        const commaPos = value.indexOf(',');
                        if (dotPos < commaPos) {
                            value = value.replace(/,/g, '');
                        } else {
                            value = value.replace(/\./g, '');
                        }
                    }
                    
                    // Remove duplicate dots
                    if ((value.match(/\./g) || []).length > 1) {
                        const firstDot = value.indexOf('.');
                        value = value.substring(0, firstDot + 1) + value.substring(firstDot + 1).replace(/\./g, '');
                    }
                    
                    // Remove duplicate commas
                    if ((value.match(/,/g) || []).length > 1) {
                        const firstComma = value.indexOf(',');
                        value = value.substring(0, firstComma + 1) + value.substring(firstComma + 1).replace(/,/g, '');
                    }
                    
                    this.value = value;
                });
            }
            
            setupAmountValidation('transactionAmount');
            setupAmountValidation('editTransactionAmount');
            setupAmountValidation('accountBalance');
            setupAmountValidation('editAccountBalance');
            setupAmountValidation('transferAmount');
            setupAmountValidation('editTransferAmount');
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('show');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active'));

            document.getElementById(`${tab}Tab`).classList.add('active');
            document.querySelector(`.menu-link[data-tab="${tab}"]`).classList.add('active');

            document.getElementById('pageTitle').textContent = tab === 'home' ? '–ì–ª–∞–≤–Ω–∞—è' : '–°—á–µ—Ç–∞';

            if (tab === 'home') {
                loadHomeData();
            } else if (tab === 'accounts') {
                loadAccounts();
            }
        }


        function formatDate(date) {
            return date.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        async function loadUserInfo() {
            if (tg.initDataUnsafe?.user) {
                const user = tg.initDataUnsafe.user;
                document.getElementById('userName').textContent = user.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                document.getElementById('userTelegramId').textContent = user.username ? `@${user.username}` : '';
            }
        }

        async function loadAccounts() {
            try {
                const response = await fetch(`${gatewayUrl}/api/accounts?telegram_id=${telegramId}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Failed to load accounts:', response.status, errorText);
                    let errorMsg = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—á–µ—Ç–æ–≤';
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMsg = errorData.error || errorMsg;
                    } catch (e) {
                        errorMsg = `–û—à–∏–±–∫–∞ ${response.status}: ${errorText || response.statusText}`;
                    }
                    showAlert(errorMsg);
                    return;
                }

                const data = await response.json();
                accounts = data.accounts || [];

                // Update balance selector
                const select = document.getElementById('balanceAccountSelect');
                if (select) {
                    select.innerHTML = '<option value="all">–í—Å–µ —Å—á–µ—Ç–∞</option>';
                    accounts.forEach(acc => {
                        const option = document.createElement('option');
                        option.value = acc.id;
                        option.textContent = acc.name;
                        select.appendChild(option);
                    });
                }

                // Update accounts list
                const list = document.getElementById('accountsList');
                if (list) {
                    if (accounts.length === 0) {
                        list.innerHTML = '<li class="empty-state"><div class="empty-state-icon">üí≥</div><div>–ù–µ—Ç —Å—á–µ—Ç–æ–≤</div></li>';
                    } else {
                        list.innerHTML = accounts.map(acc => `
                            <li class="account-item" onclick="openAccountEdit(${acc.id})">
                                <div class="account-header">
                                    <span class="account-name">${acc.name}</span>
                                    <span class="account-balance">${formatAmount(acc.balance)} ${acc.currency}</span>
                                </div>
                                <div class="account-currency">${acc.currency}</div>
                            </li>
                        `).join('');
                    }
                }

                // Update total balance
                const totalBalanceEl = document.getElementById('totalBalance');
                if (totalBalanceEl) {
                    const total = accounts.reduce((sum, acc) => sum + parseFloat(acc.balance || 0), 0);
                    totalBalanceEl.textContent = formatAmount(total) + ' ‚ÇΩ';
                }

                loadBalance();
            } catch (error) {
                console.error('Error loading accounts:', error);
                const errorMsg = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—á–µ—Ç–æ–≤: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                showAlert(errorMsg);
            }
        }

        async function loadBalance() {
            try {
                const accountId = document.getElementById('balanceAccountSelect').value;
                let balance = 0;

                if (accountId === 'all') {
                    balance = accounts.reduce((sum, acc) => sum + parseFloat(acc.balance || 0), 0);
                } else {
                    const account = accounts.find(acc => acc.id.toString() === accountId);
                    balance = account ? parseFloat(account.balance || 0) : 0;
                }

                document.getElementById('balanceAmount').textContent = formatAmount(balance) + ' ‚ÇΩ';
            } catch (error) {
                console.error('Error loading balance:', error);
            }
        }

        async function loadCategories(type) {
            try {
                const response = await fetch(`${gatewayUrl}/api/categories?telegram_id=${telegramId}&type=${type}`);
                const data = await response.json();
                categories = data.categories || [];

                // Display first 7 categories (2 rows of 4, last is "more")
                const grid = document.getElementById('categoriesGrid');
                const displayCategories = categories.slice(0, 7);
                grid.innerHTML = displayCategories.map(cat => `
                    <button type="button" class="category-button" data-category-id="${cat.id}" onclick="selectCategory(${cat.id})">
                        <div class="icon">üìÅ</div>
                        <div>${cat.name}</div>
                    </button>
                `).join('') + `
                    <button type="button" class="category-button" onclick="document.getElementById('moreCategoriesBtn').click()">
                        <div class="icon">‚ûï</div>
                        <div>–ï—â–µ</div>
                    </button>
                `;
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        async function loadAllCategories() {
            try {
                const grid = document.getElementById('allCategoriesGrid');
                grid.innerHTML = categories.map(cat => `
                    <button type="button" class="category-button" data-category-id="${cat.id}" onclick="selectCategoryFromAll(${cat.id})">
                        <div class="icon">üìÅ</div>
                        <div>${cat.name}</div>
                    </button>
                `).join('');
            } catch (error) {
                console.error('Error loading all categories:', error);
            }
        }

        function selectCategory(categoryId) {
            selectedCategoryId = categoryId;
            document.querySelectorAll('#categoriesGrid .category-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.categoryId === categoryId.toString()) {
                    btn.classList.add('active');
                }
            });
        }

        function selectCategoryFromAll(categoryId) {
            selectedCategoryId = categoryId;
            closeModal('moreCategoriesModal');
            // Update main grid selection
            document.querySelectorAll('#categoriesGrid .category-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.categoryId === categoryId.toString()) {
                    btn.classList.add('active');
                }
            });
        }

        async function loadHomeData() {
            await loadTransactions();
            await loadSummary();
        }

        async function loadTransactions() {
            try {
                const url = `${gatewayUrl}/api/transactions?telegram_id=${telegramId}&limit=100`;

                const response = await fetch(url);
                const data = await response.json();
                const transactions = (data.transactions || []).filter(tx => tx.type === currentType);

                const list = document.getElementById('transactionsList');
                if (transactions.length === 0) {
                    list.innerHTML = '<li class="empty-state"><div class="empty-state-icon">üìù</div><div>–ù–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</div></li>';
                } else {
                    list.innerHTML = transactions.map(tx => `
                        <li class="transaction-item" onclick="openTransactionEdit(${tx.id})">
                            <div class="transaction-header">
                                <span class="transaction-category">${tx.category_name || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}</span>
                                <span class="transaction-amount ${tx.type}">${tx.type === 'expense' ? '-' : '+'}${formatAmount(tx.amount)} ${tx.currency}</span>
                            </div>
                            <div class="transaction-details">
                                <span>${tx.account_name}</span>
                                <span>${formatDate(new Date(tx.operation_date))}</span>
                            </div>
                            ${tx.description ? `<div style="margin-top: 5px; font-size: 12px; opacity: 0.7;">${tx.description}</div>` : ''}
                        </li>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading transactions:', error);
                document.getElementById('transactionsList').innerHTML = '<li class="empty-state">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π</li>';
            }
        }

        async function loadSummary() {
            try {
                const url = `${gatewayUrl}/api/stats/overview?telegram_id=${telegramId}`;

                const response = await fetch(url);
                const data = await response.json();

                const amount = currentType === 'expense' ? 
                    parseFloat(data.total_expense || 0) : 
                    parseFloat(data.total_income || 0);

                document.getElementById('summaryLabel').textContent = 
                    currentType === 'expense' ? '–í—Å–µ–≥–æ —Ä–∞—Å—Ö–æ–¥–æ–≤' : '–í—Å–µ–≥–æ –¥–æ—Ö–æ–¥–æ–≤';
                document.getElementById('summaryAmount').textContent = formatAmount(amount) + ' ‚ÇΩ';
            } catch (error) {
                console.error('Error loading summary:', error);
            }
        }

        async function handleTransactionSubmit(e) {
            e.preventDefault();
            
            if (!selectedCategoryId) {
                showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
                return;
            }

            let amount = document.getElementById('transactionAmount').value.replace(',', '.');
            const date = document.getElementById('transactionDate').value;
            const comment = document.getElementById('transactionComment').value;
            const accountIdStr = document.getElementById('transactionAccount').value;
            const accountId = accountIdStr ? parseInt(accountIdStr) : null;

            if (!accountId) {
                showAlert('–í—ã–±–µ—Ä–∏—Ç–µ —Å—á–µ—Ç');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –¥–∞—Ç–∞ –Ω–µ –ø–æ–∑–∂–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è
            const today = new Date().toISOString().split('T')[0];
            if (date > today) {
                showAlert('–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å –¥–∞—Ç–æ–π –ø–æ–∑–∂–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è');
                return;
            }

            try {
                const endpoint = currentType === 'expense' ? 
                    `${gatewayUrl}/api/transactions/expense` : 
                    `${gatewayUrl}/api/transactions/income`;

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        telegram_id: telegramId,
                        account_id: accountId,
                        amount: amount,
                        category_id: selectedCategoryId,
                        description: comment,
                        operation_date: date ? new Date(date).toISOString() : new Date().toISOString()
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    showAlert('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞!');
                    closeModal('transactionModal');
                    document.getElementById('transactionForm').reset();
                    selectedCategoryId = null;
                    loadAccounts();
                    loadHomeData();
                } else {
                    showAlert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏');
                }
            } catch (error) {
                console.error('Error creating transaction:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏');
            }
        }

        async function openTransactionEdit(transactionId) {
            editingTransactionId = transactionId;
            try {
                const response = await fetch(`${gatewayUrl}/api/transactions?telegram_id=${telegramId}&limit=1000`);
                const data = await response.json();
                const transaction = data.transactions.find(tx => tx.id === transactionId);

                if (transaction) {
                    document.getElementById('editTransactionAmount').value = transaction.amount;
                    const today = new Date().toISOString().split('T')[0];
                    const transactionDate = new Date(transaction.operation_date).toISOString().split('T')[0];
                    document.getElementById('editTransactionDate').value = transactionDate;
                    document.getElementById('editTransactionDate').setAttribute('max', today);
                    document.getElementById('editTransactionComment').value = transaction.description || '';

                    // Load categories for edit
                    const catResponse = await fetch(`${gatewayUrl}/api/categories?telegram_id=${telegramId}&type=${transaction.type}`);
                    const catData = await catResponse.json();
                    const select = document.getElementById('editTransactionCategory');
                    select.innerHTML = catData.categories.map(cat => 
                        `<option value="${cat.id}" ${cat.id === transaction.category_id ? 'selected' : ''}>${cat.name}</option>`
                    ).join('');

                    openModal('transactionEditModal');
                }
            } catch (error) {
                console.error('Error loading transaction:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏');
            }
        }

        async function handleTransactionEditSubmit(e) {
            e.preventDefault();
            let amount = document.getElementById('editTransactionAmount').value.replace(',', '.');
            const categoryId = document.getElementById('editTransactionCategory').value;
            const date = document.getElementById('editTransactionDate').value;
            const comment = document.getElementById('editTransactionComment').value;
            const accountId = accounts.length > 0 ? accounts[0].id : null;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –¥–∞—Ç–∞ –Ω–µ –ø–æ–∑–∂–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è
            const today = new Date().toISOString().split('T')[0];
            if (date > today) {
                showAlert('–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å –¥–∞—Ç–æ–π –ø–æ–∑–∂–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è');
                return;
            }

            try {
                const response = await fetch(`${gatewayUrl}/api/transactions/${editingTransactionId}?telegram_id=${telegramId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        account_id: accountId,
                        amount: amount,
                        category_id: parseInt(categoryId),
                        description: comment,
                        operation_date: new Date(date).toISOString()
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    showAlert('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞!');
                    closeModal('transactionEditModal');
                    editingTransactionId = null;
                    loadAccounts();
                    loadHomeData();
                } else {
                    showAlert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏');
                }
            } catch (error) {
                console.error('Error updating transaction:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏');
            }
        }

        async function handleDeleteTransaction() {
            const confirmed = await showConfirmDialog('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é?');
            if (!confirmed) return;

            try {
                const response = await fetch(`${gatewayUrl}/api/transactions/${editingTransactionId}?telegram_id=${telegramId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (response.ok) {
                    showAlert('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞!');
                    closeModal('transactionEditModal');
                    editingTransactionId = null;
                    loadAccounts();
                    loadHomeData();
                } else {
                    showAlert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏');
                }
            } catch (error) {
                console.error('Error deleting transaction:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏');
            }
        }

        async function handleAccountSubmit(e) {
            e.preventDefault();
            const name = document.getElementById('accountName').value.trim();
            let balance = document.getElementById('accountBalance').value.trim().replace(',', '.');

            // Check for duplicate account name
            const existingAccount = accounts.find(acc => acc.name.toLowerCase() === name.toLowerCase() && !acc.is_archived);
            if (existingAccount) {
                showAlert('–°—á–µ—Ç —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
                return;
            }

            const requestBody = {
                telegram_id: telegramId,
                name: name,
                currency: 'RUB'
            };
            
            // Add balance only if provided
            if (balance && balance !== '' && balance !== '0' && balance !== '0.00') {
                requestBody.balance = balance;
            }

            try {
                const response = await fetch(`${gatewayUrl}/api/accounts`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();
                if (response.ok) {
                    showAlert('–°—á–µ—Ç —Å–æ–∑–¥–∞–Ω!');
                    closeModal('accountModal');
                    document.getElementById('accountForm').reset();
                    loadAccounts();
                } else {
                    showAlert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞');
                }
            } catch (error) {
                console.error('Error creating account:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á–µ—Ç–∞');
            }
        }

        function openAccountEdit(accountId) {
            editingAccountId = accountId;
            const account = accounts.find(acc => acc.id === accountId);
            if (account) {
                document.getElementById('editAccountName').value = account.name;
                document.getElementById('editAccountBalance').value = account.balance;
                openModal('accountEditModal');
            }
        }

        async function handleAccountEditSubmit(e) {
            e.preventDefault();
            const name = document.getElementById('editAccountName').value.trim();
            let balance = document.getElementById('editAccountBalance').value.replace(',', '.');

            // Check for duplicate account name (excluding current account)
            const existingAccount = accounts.find(acc => 
                acc.id !== editingAccountId && 
                acc.name.toLowerCase() === name.toLowerCase() && 
                !acc.is_archived
            );
            if (existingAccount) {
                showAlert('–°—á–µ—Ç —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
                return;
            }

            try {
                const response = await fetch(`${gatewayUrl}/api/accounts/${editingAccountId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        telegram_id: telegramId,
                        name: name,
                        balance: balance
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    showAlert('–°—á–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω!');
                    closeModal('accountEditModal');
                    editingAccountId = null;
                    loadAccounts();
                } else {
                    showAlert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—á–µ—Ç–∞');
                }
            } catch (error) {
                console.error('Error updating account:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—á–µ—Ç–∞');
            }
        }

        async function handleDeleteAccount() {
            const confirmed = await showConfirmDialog('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Å—á–µ—Ç? –í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.');
            if (!confirmed) return;

            try {
                const response = await fetch(`${gatewayUrl}/api/accounts/${editingAccountId}?telegram_id=${telegramId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (response.ok) {
                    showAlert('–°—á–µ—Ç —É–¥–∞–ª–µ–Ω!');
                    closeModal('accountEditModal');
                    editingAccountId = null;
                    loadAccounts();
                } else {
                    showAlert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—á–µ—Ç–∞');
                }
            } catch (error) {
                console.error('Error deleting account:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—á–µ—Ç–∞');
            }
        }

        async function loadTransferForm() {
            const fromSelect = document.getElementById('transferFromAccount');
            const toSelect = document.getElementById('transferToAccount');
            
            fromSelect.innerHTML = accounts.map(acc => 
                `<option value="${acc.id}">${acc.name} (${formatAmount(acc.balance)} ${acc.currency})</option>`
            ).join('');
            
            toSelect.innerHTML = accounts.map(acc => 
                `<option value="${acc.id}">${acc.name} (${formatAmount(acc.balance)} ${acc.currency})</option>`
            ).join('');
        }

        async function handleTransferSubmit(e) {
            e.preventDefault();
            const fromAccountId = document.getElementById('transferFromAccount').value;
            const toAccountId = document.getElementById('transferToAccount').value;
            let amount = document.getElementById('transferAmount').value.replace(',', '.');
            const comment = document.getElementById('transferComment').value;

            if (fromAccountId === toAccountId) {
                showAlert('–ù–µ–ª—å–∑—è –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å –Ω–∞ —Ç–æ—Ç –∂–µ —Å—á–µ—Ç');
                return;
            }

            try {
                const response = await fetch(`${gatewayUrl}/api/transactions/transfer`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        telegram_id: telegramId,
                        from_account_id: parseInt(fromAccountId),
                        to_account_id: parseInt(toAccountId),
                        amount: amount,
                        description: comment
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    showAlert('–ü–µ—Ä–µ–≤–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!');
                    closeModal('transferModal');
                    document.getElementById('transferForm').reset();
                    loadAccounts();
                } else {
                    showAlert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ');
                }
            } catch (error) {
                console.error('Error creating transfer:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤–æ–¥–µ');
            }
        }

        let editingTransferId = null;

        async function openTransferEdit(transferId) {
            editingTransferId = transferId;
            try {
                const response = await fetch(`${gatewayUrl}/api/transactions?telegram_id=${telegramId}&limit=1000`);
                const data = await response.json();
                const transfer = data.transactions.find(tx => tx.id === transferId && tx.type === 'transfer');

                if (transfer) {
                    // –ó–∞–ø–æ–ª–Ω–∏—Ç—å select —Å—á–µ—Ç–∞–º–∏
                    const fromSelect = document.getElementById('editTransferFromAccount');
                    const toSelect = document.getElementById('editTransferToAccount');
                    fromSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—á–µ—Ç</option>';
                    toSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—á–µ—Ç</option>';
                    
                    accounts.forEach(acc => {
                        const fromOption = document.createElement('option');
                        fromOption.value = acc.id;
                        fromOption.textContent = `${acc.name} (${formatAmount(acc.balance)} ${acc.currency})`;
                        if (acc.id == transfer.account_id) {
                            fromOption.selected = true;
                        }
                        fromSelect.appendChild(fromOption);

                        const toOption = document.createElement('option');
                        toOption.value = acc.id;
                        toOption.textContent = `${acc.name} (${formatAmount(acc.balance)} ${acc.currency})`;
                        if (transfer.related_account_id && acc.id == transfer.related_account_id) {
                            toOption.selected = true;
                        }
                        toSelect.appendChild(toOption);
                    });

                    document.getElementById('editTransferAmount').value = transfer.amount;
                    const today = new Date().toISOString().split('T')[0];
                    const transferDate = new Date(transfer.operation_date).toISOString().split('T')[0];
                    document.getElementById('editTransferDate').value = transferDate;
                    document.getElementById('editTransferDate').setAttribute('max', today);
                    document.getElementById('editTransferComment').value = transfer.description || '';

                    openModal('transferEditModal');
                }
            } catch (error) {
                console.error('Error loading transfer:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–µ—Ä–µ–≤–æ–¥–∞');
            }
        }

        async function handleTransferEditSubmit(e) {
            e.preventDefault();
            const fromAccountId = document.getElementById('editTransferFromAccount').value;
            const toAccountId = document.getElementById('editTransferToAccount').value;
            let amount = document.getElementById('editTransferAmount').value.replace(',', '.');
            const date = document.getElementById('editTransferDate').value;
            const comment = document.getElementById('editTransferComment').value;

            if (fromAccountId === toAccountId) {
                showAlert('–ù–µ–ª—å–∑—è –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å –Ω–∞ —Ç–æ—Ç –∂–µ —Å—á–µ—Ç');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –¥–∞—Ç–∞ –Ω–µ –ø–æ–∑–∂–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è
            const today = new Date().toISOString().split('T')[0];
            if (date > today) {
                showAlert('–ù–µ–ª—å–∑—è —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å –¥–∞—Ç–æ–π –ø–æ–∑–∂–µ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–≥–æ –¥–Ω—è');
                return;
            }

            try {
                const response = await fetch(`${gatewayUrl}/api/transactions/${editingTransferId}?telegram_id=${telegramId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        account_id: parseInt(fromAccountId),
                        related_account_id: parseInt(toAccountId),
                        amount: amount,
                        category_id: 0,
                        description: comment,
                        operation_date: new Date(date).toISOString()
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    showAlert('–ü–µ—Ä–µ–≤–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω!');
                    closeModal('transferEditModal');
                    editingTransferId = null;
                    loadAccounts();
                    loadTransferHistory();
                } else {
                    showAlert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–µ—Ä–µ–≤–æ–¥–∞');
                }
            } catch (error) {
                console.error('Error updating transfer:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–µ—Ä–µ–≤–æ–¥–∞');
            }
        }

        async function handleDeleteTransfer() {
            const transferIdToDelete = editingTransferId;
            if (!transferIdToDelete) {
                showAlert('–ù–µ –≤—ã–±—Ä–∞–Ω –ø–µ—Ä–µ–≤–æ–¥ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                return;
            }

            const confirmed = await showConfirmDialog('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–µ—Ä–µ–≤–æ–¥?');
            if (!confirmed) return;

            try {
                console.log('Deleting transfer:', transferIdToDelete);
                const response = await fetch(`${gatewayUrl}/api/transactions/${transferIdToDelete}?telegram_id=${telegramId}`, {
                    method: 'DELETE'
                });

                console.log('Delete response status:', response.status);

                let data = {};
                try {
                    const text = await response.text();
                    if (text) {
                        data = JSON.parse(text);
                    }
                } catch (e) {
                    console.log('Response is not JSON or empty');
                }

                if (response.ok) {
                    console.log('Transfer deleted successfully');
                    editingTransferId = null;
                    closeModal('transferEditModal');
                    
                    // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                    await Promise.all([
                        loadAccounts(),
                        loadTransferHistory()
                    ]);
                    
                    // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                    setTimeout(() => {
                        showAlert('–ü–µ—Ä–µ–≤–æ–¥ —É–¥–∞–ª–µ–Ω!');
                    }, 100);
                } else {
                    const errorMsg = data.error || `–û—à–∏–±–∫–∞ ${response.status}: ${response.statusText}`;
                    showAlert(errorMsg);
                    console.error('Delete failed:', response.status, data);
                }
            } catch (error) {
                console.error('Error deleting transfer:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–µ—Ä–µ–≤–æ–¥–∞: ' + error.message);
            }
        }

        async function loadTransferHistory() {
            try {
                const response = await fetch(`${gatewayUrl}/api/transactions?telegram_id=${telegramId}&limit=1000`);
                const data = await response.json();
                const transfers = (data.transactions || []).filter(tx => tx.type === 'transfer');

                const list = document.getElementById('transferHistoryList');
                if (transfers.length === 0) {
                    list.innerHTML = '<li class="empty-state"><div class="empty-state-icon">üí∏</div><div>–ù–µ—Ç –ø–µ—Ä–µ–≤–æ–¥–æ–≤</div></li>';
                } else {
                    list.innerHTML = transfers.map(tx => `
                        <li class="transaction-item" onclick="openTransferEdit(${tx.id})">
                            <div class="transaction-header">
                                <span class="transaction-category">${tx.description || '–ü–µ—Ä–µ–≤–æ–¥'}</span>
                                <span class="transaction-amount">${formatAmount(tx.amount)} ${tx.currency}</span>
                            </div>
                            <div class="transaction-details">
                                <span>${tx.account_name}</span>
                                <span>${formatDate(new Date(tx.operation_date))}</span>
                            </div>
                        </li>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading transfer history:', error);
                document.getElementById('transferHistoryList').innerHTML = '<li class="empty-state">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏—Å—Ç–æ—Ä–∏–∏</li>';
            }
        }

        async function handleAddCategorySubmit(e) {
            e.preventDefault();
            const name = document.getElementById('categoryName').value;

            try {
                const response = await fetch(`${gatewayUrl}/api/categories`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        telegram_id: telegramId,
                        name: name,
                        type: currentType
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    showAlert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞!');
                    closeModal('addCategoryModal');
                    document.getElementById('addCategoryForm').reset();
                    await loadCategories(currentType);
                    await loadAllCategories();
                } else {
                    showAlert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
                }
            } catch (error) {
                console.error('Error creating category:', error);
                showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
            }
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function formatAmount(amount) {
            const num = parseFloat(amount || 0);
            return num.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Add button to create transaction
        document.addEventListener('DOMContentLoaded', () => {
            const homeTab = document.getElementById('homeTab');
            const addButton = document.createElement('button');
            addButton.className = 'submit-button';
            addButton.style.cssText = 'position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; border-radius: 50%; font-size: 24px; z-index: 100;';
            addButton.textContent = '+';
            addButton.onclick = () => {
                document.getElementById('transactionModalTitle').textContent = 
                    currentType === 'expense' ? '–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥' : '–î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥';
                document.getElementById('transactionForm').reset();
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('transactionDate').value = today;
                document.getElementById('transactionDate').setAttribute('max', today);
                selectedCategoryId = null;
                document.querySelectorAll('#categoriesGrid .category-button').forEach(btn => btn.classList.remove('active'));
                
                // –ó–∞–ø–æ–ª–Ω–∏—Ç—å select —Å—á–µ—Ç–∞–º–∏
                const accountSelect = document.getElementById('transactionAccount');
                accountSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—á–µ—Ç</option>';
                accounts.forEach(acc => {
                    const option = document.createElement('option');
                    option.value = acc.id;
                    option.textContent = `${acc.name} (${formatAmount(acc.balance)} ${acc.currency})`;
                    accountSelect.appendChild(option);
                });
                
                openModal('transactionModal');
            };
            homeTab.appendChild(addButton);
        });
    </script>
</body>
</html>
