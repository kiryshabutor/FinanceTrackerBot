<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Tracker</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #1a5f3f;
            color: white;
            overflow-x: hidden;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: #1a5f3f;
            padding: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s;
        }

        .sidebar.hidden {
            transform: translateX(-100%);
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .sidebar-header .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 24px;
        }

        .sidebar-header .user-info h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .sidebar-header .user-info p {
            font-size: 14px;
            opacity: 0.8;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 10px;
        }

        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 15px;
            color: white;
            text-decoration: none;
            border-radius: 10px;
            transition: background 0.3s;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: rgba(255,255,255,0.1);
        }

        .sidebar-menu a .icon {
            width: 24px;
            height: 24px;
            margin-right: 15px;
            font-size: 20px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            background: #1a5f3f;
            min-height: 100vh;
        }

        .top-bar {
            background: #1a5f3f;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .menu-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }

        .balance-header {
            text-align: center;
            flex: 1;
        }

        .balance-header .total {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .balance-header .label {
            font-size: 14px;
            opacity: 0.8;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            border-bottom: 2px solid rgba(255,255,255,0.2);
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: border-color 0.3s;
        }

        .tab.active {
            border-bottom-color: #4CAF50;
        }

        /* Period Selector */
        .period-selector {
            background: rgba(0,0,0,0.2);
            padding: 15px 20px;
            margin: 20px;
            border-radius: 10px;
        }

        .period-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .period-tab {
            padding: 8px 15px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .period-tab.active {
            background: #4CAF50;
        }

        .date-range {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
        }

        .date-nav {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px 10px;
        }

        .date-display {
            font-size: 16px;
        }

        /* Content Area */
        .content-area {
            padding: 20px;
        }

        .card {
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card h2 {
            margin-bottom: 15px;
            font-size: 18px;
        }

        .summary-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .summary-value {
            font-size: 24px;
            font-weight: bold;
        }

        .add-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #FFC107;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .category-list {
            list-style: none;
        }

        .category-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
        }

        .category-item .icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(76, 175, 80, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 20px;
        }

        .category-info {
            flex: 1;
        }

        .category-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .category-percent {
            font-size: 14px;
            opacity: 0.8;
        }

        .category-amount {
            font-size: 18px;
            font-weight: bold;
        }

        .transaction-list {
            list-style: none;
        }

        .transaction-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .transaction-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-category {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .transaction-date {
            font-size: 12px;
            opacity: 0.7;
        }

        .transaction-amount {
            font-size: 18px;
            font-weight: bold;
        }

        .transaction-amount.expense {
            color: #f44336;
        }

        .transaction-amount.income {
            color: #4CAF50;
        }

        .transaction-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .edit-btn {
            background: #2196F3;
            color: white;
        }

        .delete-btn {
            background: #f44336;
            color: white;
        }

        /* Forms */
        .form-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .form-overlay.hidden {
            display: none;
        }

        .form-card {
            background: #1a5f3f;
            border-radius: 15px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 16px;
        }

        .form-group input::placeholder {
            color: rgba(255,255,255,0.5);
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        /* Charts */
        .chart-container {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="avatar">üí∞</div>
                <div class="user-info">
                    <h3 id="user-name">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h3>
                    <p>–û—Å—Ç–∞—Ç–æ–∫: <span id="sidebar-balance">0</span> ‚ÇΩ</p>
                </div>
            </div>
            <ul class="sidebar-menu">
                <li><a href="#" class="menu-item active" data-view="home"><span class="icon">üè†</span> –ì–ª–∞–≤–Ω–∞—è</a></li>
                <li><a href="#" class="menu-item" data-view="accounts"><span class="icon">üí≥</span> –°—á–µ—Ç–∞</a></li>
                <li><a href="#" class="menu-item" data-view="categories"><span class="icon">üìÅ</span> –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</a></li>
                <li><a href="#" class="menu-item" data-view="charts"><span class="icon">üìä</span> –ì—Ä–∞—Ñ–∏–∫–∏</a></li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="top-bar">
                <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
                <div class="balance-header">
                    <div class="total" id="total-balance">0 ‚ÇΩ</div>
                    <div class="label">–ò—Ç–æ–≥–æ</div>
                </div>
                <div style="width: 40px;"></div>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="switchTab('expense')">–†–ê–°–•–û–î–´</button>
                <button class="tab" onclick="switchTab('income')">–î–û–•–û–î–´</button>
            </div>

            <!-- Period Selector -->
            <div class="period-selector">
                <div class="period-tabs">
                    <button class="period-tab active" onclick="selectPeriod('today')">–î–µ–Ω—å</button>
                    <button class="period-tab" onclick="selectPeriod('week')">–ù–µ–¥–µ–ª—è</button>
                    <button class="period-tab" onclick="selectPeriod('month')">–ú–µ—Å—è—Ü</button>
                    <button class="period-tab" onclick="selectPeriod('year')">–ì–æ–¥</button>
                    <button class="period-tab" onclick="selectPeriod('period')">–ü–µ—Ä–∏–æ–¥</button>
                </div>
                <div class="date-range">
                    <button class="date-nav" onclick="changeDateRange(-1)">‚Üê</button>
                    <div class="date-display" id="date-range">17 –Ω–æ—è–±. - 23 –Ω–æ—è–±.</div>
                    <button class="date-nav" onclick="changeDateRange(1)">‚Üí</button>
                </div>
            </div>

            <!-- Content Views -->
            <div class="content-area">
                <!-- Home View -->
                <div id="home-view" class="view">
                    <div class="card">
                        <div class="summary-card">
                            <div>
                                <div style="font-size: 14px; opacity: 0.8; margin-bottom: 5px;">–°—É–º–º–∞ <span id="current-tab-label">—Ä–∞—Å—Ö–æ–¥–æ–≤</span></div>
                                <div class="summary-value" id="summary-amount">0 ‚ÇΩ</div>
                            </div>
                            <button class="add-button" onclick="showAddForm()">+</button>
                        </div>
                    </div>

                    <div class="card">
                        <h2>–ü–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h2>
                        <ul class="category-list" id="category-list"></ul>
                    </div>

                    <div class="card">
                        <h2>–û–ø–µ—Ä–∞—Ü–∏–∏</h2>
                        <ul class="transaction-list" id="transaction-list"></ul>
                    </div>
                </div>

                <!-- Accounts View -->
                <div id="accounts-view" class="view hidden">
                    <div class="card">
                        <h2>–°—á–µ—Ç–∞</h2>
                        <button class="btn btn-primary" onclick="showCreateAccountForm()" style="width: 100%; margin-bottom: 20px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å—á—ë—Ç</button>
                        <ul class="transaction-list" id="accounts-list"></ul>
                    </div>
                </div>

                <!-- Categories View -->
                <div id="categories-view" class="view hidden">
                    <div class="card">
                        <h2>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
                        <div class="form-group">
                            <select id="category-type-filter" onchange="loadCategoriesForManage()">
                                <option value="expense">–†–∞—Å—Ö–æ–¥—ã</option>
                                <option value="income">–î–æ—Ö–æ–¥—ã</option>
                            </select>
                        </div>
                        <ul class="transaction-list" id="categories-list"></ul>
                    </div>
                </div>

                <!-- Charts View -->
                <div id="charts-view" class="view hidden">
                    <div class="card">
                        <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
                        <div class="chart-container">
                            <canvas id="category-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Transaction Form -->
    <div class="form-overlay hidden" id="transaction-form-overlay">
        <div class="form-card">
            <h2 id="form-title">–î–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é</h2>
            <div class="form-group">
                <label>–°—É–º–º–∞</label>
                <input type="text" id="form-amount" placeholder="1000.00">
            </div>
            <div class="form-group">
                <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select id="form-category"></select>
                <button class="btn btn-secondary" onclick="showCreateCategoryForm()" style="width: 100%; margin-top: 10px;">‚ûï –°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
            </div>
            <div class="form-group">
                <label>–°—á—ë—Ç</label>
                <select id="form-account"></select>
            </div>
            <div class="form-group">
                <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <input type="text" id="form-description" placeholder="–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ">
            </div>
            <div class="form-group">
                <label>–î–∞—Ç–∞</label>
                <input type="date" id="form-date">
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideTransactionForm()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="submitTransaction()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Create Account Form -->
    <div class="form-overlay hidden" id="account-form-overlay">
        <div class="form-card">
            <h2>–°–æ–∑–¥–∞—Ç—å —Å—á—ë—Ç</h2>
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" id="account-name-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Å—á—ë—Ç–∞">
            </div>
            <div class="form-group">
                <label>–í–∞–ª—é—Ç–∞</label>
                <select id="account-currency-input">
                    <option value="RUB">RUB</option>
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                </select>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideAccountForm()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="submitCreateAccount()">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- Create Category Form -->
    <div class="form-overlay hidden" id="category-form-overlay">
        <div class="form-card">
            <h2>–°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h2>
            <div class="form-group">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" id="category-name-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏">
            </div>
            <div class="form-group">
                <label>–¢–∏–ø</label>
                <select id="category-type-input">
                    <option value="expense">–†–∞—Å—Ö–æ–¥</option>
                    <option value="income">–î–æ—Ö–æ–¥</option>
                </select>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideCategoryForm()">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="submitCreateCategory()">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const telegramId = tg.initDataUnsafe.user.id;
        const gatewayUrl = window.location.origin.replace('/webapp', '');

        let currentView = 'home';
        let currentTab = 'expense';
        let currentPeriod = 'week';
        let editingTransactionId = null;
        let categoryChart = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setupMenu();
            document.getElementById('form-date').valueAsDate = new Date();
        });

        function setupMenu() {
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const view = item.dataset.view;
                    switchView(view);
                });
            });
        }

        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            document.getElementById(`${view}-view`).classList.remove('hidden');
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.view === view) {
                    item.classList.add('active');
                }
            });

            if (view === 'charts') {
                loadCharts();
            } else if (view === 'accounts') {
                loadAccountsForManage();
            } else if (view === 'categories') {
                loadCategoriesForManage();
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('current-tab-label').textContent = tab === 'expense' ? '—Ä–∞—Å—Ö–æ–¥–æ–≤' : '–¥–æ—Ö–æ–¥–æ–≤';
            loadData();
        }

        function selectPeriod(period) {
            currentPeriod = period;
            document.querySelectorAll('.period-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            loadData();
        }

        function changeDateRange(direction) {
            // TODO: Implement date range navigation
            loadData();
        }

        async function loadData() {
            try {
                await Promise.all([
                    loadBalance(),
                    loadAccounts(),
                    loadCategories(currentTab),
                    loadTransactions(),
                    loadSummary()
                ]);
            } catch (error) {
                tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
            }
        }

        async function loadBalance() {
            const response = await fetch(`${gatewayUrl}/api/balance?telegram_id=${telegramId}`);
            const data = await response.json();
            const total = data.accounts.reduce((sum, acc) => sum + parseFloat(acc.balance), 0);
            document.getElementById('total-balance').textContent = `${total.toFixed(2)} ‚ÇΩ`;
            document.getElementById('sidebar-balance').textContent = total.toFixed(2);
        }

        async function loadAccounts() {
            const response = await fetch(`${gatewayUrl}/api/accounts?telegram_id=${telegramId}`);
            const data = await response.json();
            const accounts = data.accounts;
            
            ['form-account'].forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = accounts.map(acc => 
                        `<option value="${acc.id}">${acc.name} (${acc.balance} ${acc.currency})</option>`
                    ).join('');
                }
            });
        }

        async function loadCategories(type) {
            const response = await fetch(`${gatewayUrl}/api/categories?telegram_id=${telegramId}&type=${type}`);
            const data = await response.json();
            const select = document.getElementById('form-category');
            if (select) {
                select.innerHTML = data.categories.map(cat => 
                    `<option value="${cat.id}">${cat.name}</option>`
                ).join('');
            }
        }

        async function loadTransactions() {
            const response = await fetch(`${gatewayUrl}/api/transactions?telegram_id=${telegramId}&period=${currentPeriod}&limit=100`);
            const data = await response.json();
            const container = document.getElementById('transaction-list');
            
            if (!container) return;

            const filtered = data.transactions.filter(tx => tx.type === currentTab);
            
            if (filtered.length === 0) {
                container.innerHTML = '<li style="text-align: center; padding: 20px; opacity: 0.7;">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</li>';
                return;
            }

            container.innerHTML = filtered.map(tx => {
                const className = tx.type === 'expense' ? 'expense' : 'income';
                const date = new Date(tx.operation_date).toLocaleDateString('ru-RU');
                return `
                    <li class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-category">${tx.category_name || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}</div>
                            <div class="transaction-date">${date}</div>
                        </div>
                        <div class="transaction-amount ${className}">${tx.type === 'expense' ? '-' : '+'}${tx.amount} ${tx.currency}</div>
                        <div class="transaction-actions">
                            <button class="action-btn edit-btn" onclick="editTransaction(${tx.id})">‚úèÔ∏è</button>
                            <button class="action-btn delete-btn" onclick="deleteTransaction(${tx.id})">üóëÔ∏è</button>
                        </div>
                    </li>
                `;
            }).join('');
        }

        async function loadSummary() {
            try {
                const response = await fetch(`${gatewayUrl}/api/stats/by-category?telegram_id=${telegramId}&period=${currentPeriod}`);
                const data = await response.json();
                
                const total = data.categories.reduce((sum, cat) => sum + parseFloat(cat.total_expense || 0), 0);
                document.getElementById('summary-amount').textContent = `${total.toFixed(2)} ‚ÇΩ`;

                // Load category list
                const categoryList = document.getElementById('category-list');
                if (categoryList) {
                    const filtered = data.categories.filter(cat => {
                        // Filter by current tab
                        return true; // TODO: filter by expense/income
                    });

                    if (filtered.length === 0) {
                        categoryList.innerHTML = '<li style="text-align: center; padding: 20px; opacity: 0.7;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</li>';
                        return;
                    }

                    categoryList.innerHTML = filtered.map(cat => {
                        const percent = total > 0 ? ((parseFloat(cat.total_expense || 0) / total) * 100).toFixed(0) : 0;
                        return `
                            <li class="category-item">
                                <div class="icon">üìÅ</div>
                                <div class="category-info">
                                    <div class="category-name">${cat.name}</div>
                                    <div class="category-percent">${percent}%</div>
                                </div>
                                <div class="category-amount">${parseFloat(cat.total_expense || 0).toFixed(2)} ‚ÇΩ</div>
                            </li>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error loading summary:', error);
            }
        }

        function showAddForm() {
            editingTransactionId = null;
            document.getElementById('form-title').textContent = `–î–æ–±–∞–≤–∏—Ç—å ${currentTab === 'expense' ? '—Ä–∞—Å—Ö–æ–¥' : '–¥–æ—Ö–æ–¥'}`;
            document.getElementById('transaction-form-overlay').classList.remove('hidden');
            loadCategories(currentTab);
        }

        function hideTransactionForm() {
            document.getElementById('transaction-form-overlay').classList.add('hidden');
            editingTransactionId = null;
        }

        async function submitTransaction() {
            const amount = document.getElementById('form-amount').value;
            const categoryId = document.getElementById('form-category').value;
            const accountId = document.getElementById('form-account').value;
            const description = document.getElementById('form-description').value;
            const date = document.getElementById('form-date').value;

            if (!amount || !categoryId || !accountId) {
                tg.showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
                return;
            }

            try {
                const endpoint = editingTransactionId 
                    ? `${gatewayUrl}/api/transactions/${editingTransactionId}`
                    : `${gatewayUrl}/api/transactions/${currentTab}`;
                
                const method = editingTransactionId ? 'PUT' : 'POST';
                
                const body = editingTransactionId ? {
                    telegram_id: telegramId,
                    account_id: parseInt(accountId),
                    amount: amount,
                    category_id: parseInt(categoryId),
                    description: description,
                    operation_date: date ? new Date(date).toISOString() : new Date().toISOString()
                } : {
                    telegram_id: telegramId,
                    account_id: parseInt(accountId),
                    amount: amount,
                    category_id: parseInt(categoryId),
                    description: description
                };

                const response = await fetch(endpoint, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(body)
                });

                const data = await response.json();
                if (response.ok) {
                    tg.showAlert(editingTransactionId ? '–û–ø–µ—Ä–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞!' : '–û–ø–µ—Ä–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞!');
                    hideTransactionForm();
                    loadData();
                } else {
                    tg.showAlert(data.error || '–û—à–∏–±–∫–∞');
                }
            } catch (error) {
                tg.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
            }
        }

        async function editTransaction(id) {
            // Load transaction data and show form
            editingTransactionId = id;
            document.getElementById('form-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é';
            document.getElementById('transaction-form-overlay').classList.remove('hidden');
            // TODO: Load transaction data into form
        }

        async function deleteTransaction(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –æ–ø–µ—Ä–∞—Ü–∏—é?')) {
                return;
            }

            try {
                const response = await fetch(`${gatewayUrl}/api/transactions/${id}?telegram_id=${telegramId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (response.ok) {
                    tg.showAlert('–û–ø–µ—Ä–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞!');
                    loadData();
                } else {
                    tg.showAlert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
                }
            } catch (error) {
                tg.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
            }
        }

        async function loadAccountsForManage() {
            const response = await fetch(`${gatewayUrl}/api/accounts?telegram_id=${telegramId}`);
            const data = await response.json();
            const container = document.getElementById('accounts-list');
            
            if (!container) return;

            if (data.accounts.length === 0) {
                container.innerHTML = '<li style="text-align: center; padding: 20px; opacity: 0.7;">–ù–µ—Ç —Å—á–µ—Ç–æ–≤</li>';
                return;
            }

            container.innerHTML = data.accounts.map(acc => `
                <li class="transaction-item">
                    <div class="transaction-info">
                        <div class="transaction-category">${acc.name}</div>
                        <div class="transaction-date">${acc.balance} ${acc.currency}</div>
                    </div>
                    <button class="action-btn delete-btn" onclick="deleteAccount(${acc.id})">üóëÔ∏è</button>
                </li>
            `).join('');
        }

        async function showCreateAccountForm() {
            document.getElementById('account-form-overlay').classList.remove('hidden');
        }

        function hideAccountForm() {
            document.getElementById('account-form-overlay').classList.add('hidden');
        }

        async function submitCreateAccount() {
            const name = document.getElementById('account-name-input').value;
            const currency = document.getElementById('account-currency-input').value;

            if (!name) {
                tg.showAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—á—ë—Ç–∞');
                return;
            }

            try {
                const response = await fetch(`${gatewayUrl}/api/accounts`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        telegram_id: telegramId,
                        name: name,
                        currency: currency
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    tg.showAlert('–°—á—ë—Ç —Å–æ–∑–¥–∞–Ω!');
                    hideAccountForm();
                    loadAccountsForManage();
                    loadData();
                } else {
                    tg.showAlert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á—ë—Ç–∞');
                }
            } catch (error) {
                tg.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—á—ë—Ç–∞');
            }
        }

        async function deleteAccount(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Å—á—ë—Ç? –ë–∞–ª–∞–Ω—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–∞–≤–µ–Ω –Ω—É–ª—é.')) {
                return;
            }

            try {
                const response = await fetch(`${gatewayUrl}/api/accounts/${id}?telegram_id=${telegramId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (response.ok) {
                    tg.showAlert('–°—á—ë—Ç —É–¥–∞–ª—ë–Ω!');
                    loadAccountsForManage();
                    loadData();
                } else {
                    tg.showAlert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—á—ë—Ç–∞');
                }
            } catch (error) {
                tg.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—á—ë—Ç–∞');
            }
        }

        async function loadCategoriesForManage() {
            const type = document.getElementById('category-type-filter').value;
            
            try {
                const response = await fetch(`${gatewayUrl}/api/categories?telegram_id=${telegramId}&type=${type}`);
                const data = await response.json();
                const container = document.getElementById('categories-list');
                
                if (!container) return;

                const userCategories = data.categories; // TODO: filter system categories

                if (userCategories.length === 0) {
                    container.innerHTML = '<li style="text-align: center; padding: 20px; opacity: 0.7;">–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π</li>';
                    return;
                }

                container.innerHTML = userCategories.map(cat => `
                    <li class="transaction-item">
                        <div class="transaction-info">
                            <div class="transaction-category">${cat.name}</div>
                        </div>
                        <button class="action-btn delete-btn" onclick="deleteCategory(${cat.id}, '${type}')">üóëÔ∏è</button>
                    </li>
                `).join('');
            } catch (error) {
                tg.showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π');
            }
        }

        function showCreateCategoryForm() {
            const type = currentTab || 'expense';
            document.getElementById('category-type-input').value = type;
            document.getElementById('category-form-overlay').classList.remove('hidden');
        }

        function hideCategoryForm() {
            document.getElementById('category-form-overlay').classList.add('hidden');
        }

        async function submitCreateCategory() {
            const name = document.getElementById('category-name-input').value;
            const type = document.getElementById('category-type-input').value;

            if (!name) {
                tg.showAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
                return;
            }

            try {
                const response = await fetch(`${gatewayUrl}/api/categories`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        telegram_id: telegramId,
                        name: name,
                        type: type
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    tg.showAlert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞!');
                    document.getElementById('category-name-input').value = '';
                    hideCategoryForm();
                    await loadCategories(type);
                    if (currentView === 'categories') {
                        loadCategoriesForManage();
                    }
                } else {
                    tg.showAlert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
                }
            } catch (error) {
                tg.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
            }
        }

        async function deleteCategory(id, type) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–∞—Ç–µ–≥–æ—Ä–∏—é? –í—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –±—É–¥—É—Ç –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é "–ü—Ä–æ—á–µ–µ".')) {
                return;
            }

            try {
                const response = await fetch(`${gatewayUrl}/api/categories/${id}?telegram_id=${telegramId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();
                if (response.ok) {
                    tg.showAlert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞!');
                    loadCategoriesForManage();
                    await loadCategories(type);
                } else {
                    tg.showAlert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
                }
            } catch (error) {
                tg.showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
            }
        }

        async function loadCharts() {
            try {
                const response = await fetch(`${gatewayUrl}/api/stats/by-category?telegram_id=${telegramId}&period=${currentPeriod}`);
                const data = await response.json();
                
                const ctx = document.getElementById('category-chart').getContext('2d');
                
                if (categoryChart) {
                    categoryChart.destroy();
                }

                categoryChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: data.categories.map(cat => cat.name),
                        datasets: [{
                            data: data.categories.map(cat => parseFloat(cat.total_expense || 0)),
                            backgroundColor: [
                                '#4CAF50',
                                '#2196F3',
                                '#FF9800',
                                '#9C27B0',
                                '#F44336',
                                '#00BCD4',
                                '#FFC107'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: 'white'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading charts:', error);
            }
        }
    </script>
</body>
</html>




